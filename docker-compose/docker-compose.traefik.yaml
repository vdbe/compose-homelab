secrets:
  cf_api_email:
    file: ${SECRET_DIR}/cf_api_email.secret
  cf_zone_api_token:
    file: ${SECRET_DIR}/cf_zone_api_token.secret
  cf_dns_api_token:
    file: ${SECRET_DIR}/cf_dns_api_token.secret

networks:
  00_net_traefik:
  cloudflare_tunnel:

volumes:
  traefik-letsencrypt:

services:
  traefik:
    image: "traefik:latest"

    secrets:
      - cf_api_email
      - cf_zone_api_token
      - cf_dns_api_token

    env_file:
      - ${CONFIG_DIR}/traefik/env_file.env

    networks:
      00_net_traefik:
        priority: 100
        aliases:
          - "ingress"
      cloudflare_tunnel:
        aliases:
          - "ingress-cloudflare"
          - "traefik-cloudflare"


    command:
      #- "--log.level=DEBUG"
      - "--api=false"
      #- "--api.insecure=true"
      #- "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      #- "--entrypoints.web.address=ingress:80"
      - "--entrypoints.websecure.address=ingress:443"
      - "--entrypoints.cloudflare.address=ingress-cloudflare:443"

      - "--certificatesresolvers.staging.acme.dnschallenge=true"
      - "--certificatesresolvers.staging.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.staging.acme.dnschallenge.delaybeforecheck=10"
      - "--certificatesresolvers.staging.acme.dnschallenge.resolvers=1.1.1.1:53"
      - "--certificatesresolvers.staging.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
      - "--certificatesresolvers.staging.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.staging.acme.storage=/letsencrypt/staging-acme.json"

      - "--certificatesresolvers.production.acme.dnschallenge=true"
      - "--certificatesresolvers.production.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.production.acme.dnschallenge.delaybeforecheck=10"
      - "--certificatesresolvers.production.acme.dnschallenge.resolvers=1.1.1.1:53"
      - "--certificatesresolvers.production.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.production.acme.storage=/letsencrypt/production-acme.json"

    labels:
      com.centurylinklabs.watchtower.enable: "${DEFAULT_WATCHTOWER_ENABLE}"
      com.centurylinklabs.watchtower.scope: "${DEFAULT_WATCHTOWER_SCOPE}"

    ports:
      #- "80:80"
      - "443:443"
      #- "8080:8080"

    volumes:
      - "traefik-letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"

